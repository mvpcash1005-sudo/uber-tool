<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Uber å…¨èƒ½é§•é§›æˆ°æƒ…å®¤</title>
    <style>
        /* --- å…¨å±€è¨­å®š (æš—é»‘é§•é§›æ¨¡å¼) --- */
        body { background-color: #000; color: #fff; font-family: -apple-system, BlinkMacSystemFont, Roboto, sans-serif; margin: 0; padding: 0; padding-bottom: 70px; /* é ç•™åº•éƒ¨å°èˆªç©ºé–“ */ }
        h2 { margin: 0; padding: 15px; text-align: center; background: #111; color: #00ff99; border-bottom: 1px solid #333; font-size: 18px; }
        
        /* --- åº•éƒ¨å°èˆªåˆ— --- */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #1a1a1a; display: flex; border-top: 1px solid #333; z-index: 1000; }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #666; font-size: 12px; cursor: pointer; }
        .nav-item.active { color: #00ff99; background: #222; }
        .nav-icon { font-size: 20px; margin-bottom: 3px; }

        /* --- åˆ†é å…§å®¹å®¹å™¨ --- */
        .tab-content { display: none; padding: 15px; animation: fadeIn 0.3s; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- é€šç”¨å…ƒä»¶æ¨£å¼ --- */
        input, select { width: 100%; padding: 12px; background: #222; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 16px; margin-bottom: 10px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .btn-green { background: #00c853; color: white; }
        .btn-blue { background: #2979ff; color: white; }
        .btn-red { background: #d32f2f; color: white; }
        .btn-gps { width: 50px; background: #ff9800; color: white; margin-top: 0; }
        
        /* çµé‡‘é›·é”å¡ç‰‡ */
        .card { background: #1a1a1a; border-radius: 8px; padding: 15px; margin-bottom: 15px; border-left: 4px solid #444; position: relative; }
        .card.hot { border-left-color: #ff3d00; } /* ç†±é–€ç´…è‰² */
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .card-title { font-size: 18px; font-weight: bold; }
        .badge { padding: 3px 6px; border-radius: 4px; font-size: 12px; margin-left: 5px; }
        .badge-price { background: #00c853; color: #fff; }
        .badge-dist { background: #2979ff; color: #fff; }
        .nav-link { display: block; text-align: center; background: #333; padding: 10px; border-radius: 6px; margin-top: 10px; text-decoration: none; color: white; font-weight: bold; }

        /* ä¼°åƒ¹çµæœå€ */
        .price-display { text-align: center; margin-top: 20px; padding: 20px; background: #1a1a1a; border-radius: 12px; border: 1px solid #333; }
        .big-price { font-size: 40px; color: #00ff99; font-weight: bold; margin: 10px 0; }
        .status-tag { display: inline-block; padding: 5px 12px; border-radius: 15px; font-size: 13px; margin-bottom: 10px; }
        .status-rush { background: #3e1a1a; color: #ff5252; border: 1px solid #ff5252; }
        .status-normal { background: #1a2f3e; color: #40c4ff; border: 1px solid #40c4ff; }
        .status-night { background: #1a3e1a; color: #69f0ae; border: 1px solid #69f0ae; }

        /* æˆ°ç•¥ç­†è¨˜å€ */
        .strategy-box { background: #222; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .strategy-title { color: #ffcc00; font-weight: bold; margin-bottom: 5px; display: flex; align-items: center; }
        .strategy-text { color: #ccc; font-size: 14px; line-height: 1.5; }
    </style>
</head>
<body>

    <h2 id="pageTitle">é›·é”åµæ¸¬ä¸­...</h2>

    <div id="tab-radar" class="tab-content active">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="radarInput" placeholder="è¼¸å…¥ç›®å‰ä½ç½®...">
            <button class="btn-gps" onclick="useGPS()">ğŸ“¡</button>
        </div>
        <select id="radarTimeSelect" onchange="findHotspots()">
            </select>
        <button class="btn-green" onclick="findHotspots()">ğŸ” æƒæç†±é»</button>
        <button onclick="toggleAddPanel()" style="background:#333; color:#aaa; font-size:14px; padding:8px;">â• æ–°å¢ç§æˆ¿é»</button>
        
        <div id="addPanel" style="display:none; background:#222; padding:10px; margin-top:10px; border-radius:8px;">
            <input type="text" id="newName" placeholder="åç¨± (ä¾‹: å…§ç§‘)">
            <input type="number" id="newPrice" placeholder="é‡‘é¡ (ä¾‹: 500)">
            <input type="text" id="newNote" placeholder="å‚™è¨»">
            <div style="color:#888; font-size:12px; margin-bottom:5px;">ğŸ‘‡ é¸æ“‡ç†±é–€æ™‚æ®µ (0-23)</div>
            <input type="text" id="newHours" placeholder="ä¾‹: 17,18,19 (ç”¨é€—è™Ÿéš”é–‹)">
            <button class="btn-blue" onclick="addSpot()">ğŸ’¾ å„²å­˜</button>
        </div>

        <div id="radarResults" style="margin-top:15px;"></div>
    </div>

    <div id="tab-calc" class="tab-content">
        <div id="trafficStatus" class="status-tag status-normal" style="width:100%; text-align:center; box-sizing:border-box;">åµæ¸¬æ™‚æ®µä¸­...</div>
        
        <label style="color:#888; font-size:12px;">ä¸Šè»Šåœ°é»</label>
        <input type="text" id="startAddr" placeholder="è«‹è¼¸å…¥åœ°å€">
        
        <label style="color:#888; font-size:12px;">ä¸‹è»Šåœ°é»</label>
        <input type="text" id="endAddr" placeholder="è«‹è¼¸å…¥åœ°å€">
        
        <button class="btn-blue" onclick="calculateFare()">ğŸ’° è¨ˆç®—å ±åƒ¹</button>

        <div id="calcResult" class="price-display" style="display:none;">
            <div style="color:#aaa; font-size:12px;">é ä¼°è»Šè³‡</div>
            <div class="big-price" id="displayPrice">$0</div>
            <div style="color:#888; font-size:13px; text-align:left; margin-top:10px;">
                ğŸ“ è·é›¢ï¼š<span id="displayDist">0</span> km<br>
                â±ï¸ æ™‚é–“ï¼š<span id="displayTime">0</span> åˆ†<br>
                ğŸš¦ å»¶æ»¯ä¿‚æ•¸ï¼š<span id="displayFactor">ä¸€èˆ¬</span>
            </div>
            <a href="#" id="lineLink" class="nav-link" style="background:#06c755; margin-top:15px;">ğŸ’¬ LINE ç™¼é€å ±åƒ¹å–®</a>
        </div>
    </div>

    <div id="tab-strategy" class="tab-content">
        <div class="strategy-box">
            <div class="strategy-title">ğŸ›‘ åœææ³•å‰‡ (Stop Loss)</div>
            <div class="strategy-text">
                æ¥äºº > 8åˆ†é˜ï¼š<b>æ‹’æ¥</b> (é™¤éåŠ æˆ > 1.5x)<br>
                æ¥äºº > è¡Œç¨‹æ™‚é–“ï¼š<b>çµ•å°æ‹’æ¥</b> (è™§æœ¬ç”Ÿæ„)
            </div>
        </div>
        <div class="strategy-box">
            <div class="strategy-title">âš–ï¸ é»ƒé‡‘æ¯”ä¾‹ (1:2)</div>
            <div class="strategy-text">
                æ¥äºº 5 åˆ†é˜ï¼Œè¡Œç¨‹è‡³å°‘è¦ 10 åˆ†é˜ã€‚<br>
                è‹¥æ¯”ä¾‹ä½æ–¼ 1:2ï¼Œåƒ…åœ¨ç‚ºäº†è¡è¶Ÿæ¬¡çå‹µæ™‚æ‰æ¥ã€‚
            </div>
        </div>
        <div class="strategy-box">
            <div class="strategy-title">ğŸ—ºï¸ åœ°å½¢æˆ°è¡“</div>
            <div class="strategy-text">
                <b>07:00-09:00ï¼š</b> å¾…åœ¨æ–°åŒ— (æ¿æ©‹/ä¸‰é‡) æ¥é€²åŸå–®ã€‚<br>
                <b>17:00-19:00ï¼š</b> å¾…åœ¨åŒ—å¸‚ (å…§ç§‘/ä¿¡ç¾©) æ¥å›ç¨‹å–®ã€‚<br>
                <b>ç´…å€é™·é˜±ï¼š</b> ä¸è¦åœåœ¨ç´…å€æ­£ä¸­å¿ƒï¼Œåœåœ¨é‚Šç·£ 500m è™•ã€‚
            </div>
        </div>
        <div class="strategy-box">
            <div class="strategy-title">ğŸ‘» æ´—ç™½å®šä½</div>
            <div class="strategy-text">
                ç©ºè»Š > 10åˆ†é˜æ²’å–®ï¼š<br>
                1. ä¸‹ç·š (Offline)<br>
                2. ç§»å‹• 500 å…¬å°º<br>
                3. é‡æ–°ä¸Šç·š (Online)
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('radar')">
            <div class="nav-icon">ğŸ“¡</div>
            <div>é›·é”</div>
        </div>
        <div class="nav-item" onclick="switchTab('calc')">
            <div class="nav-icon">ğŸ–©</div>
            <div>ä¼°åƒ¹</div>
        </div>
        <div class="nav-item" onclick="switchTab('strategy')">
            <div class="nav-icon">ğŸ“</div>
            <div>ç­†è¨˜</div>
        </div>
    </div>

    <script>
        // ================= å…¨å±€è¨­å®š =================
        const MY_LINE_ID = "love_ice_boy"; // âœ… å·²ä¿®æ”¹ç‚ºä½ çš„ ID

        // è³‡æ–™åº«åˆå§‹åŒ–
        const defaultSpots = [
            { name: "ä¿¡ç¾© ATT", lat: 25.0355, lon: 121.5663, price: 550, hours: [22,23,0,1,2,3], note: "å¤œåº—å–®" },
            { name: "å…§ç§‘ç‘å…‰", lat: 25.0805, lon: 121.5721, price: 500, hours: [17,18,19], note: "ä¸‹ç­æ½®" },
            { name: "æ¿æ©‹è»Šç«™", lat: 25.0139, lon: 121.4640, price: 450, hours: [7,8,9,17,18], note: "é«˜éµ/é€šå‹¤" },
            { name: "æ—å£ä¸‰äº•", lat: 25.0718, lon: 121.3653, price: 800, hours: [14,15,16,19,20], note: "é•·é€”å›å°åŒ—" }
        ];
        let myHotspots = JSON.parse(localStorage.getItem('uberDriverData')) || defaultSpots;
        let currentLat, currentLon;

        // ================= åˆ†é åˆ‡æ›é‚è¼¯ =================
        function switchTab(tabName) {
            // éš±è—æ‰€æœ‰åˆ†é 
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            
            // é¡¯ç¤ºç›®æ¨™åˆ†é 
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // æ›´æ–°å°èˆªæ¨£å¼
            const navIndex = tabName === 'radar' ? 0 : tabName === 'calc' ? 1 : 2;
            document.querySelectorAll('.nav-item')[navIndex].classList.add('active');

            // æ›´æ–°æ¨™é¡Œ
            const titles = { 'radar': 'çµé‡‘é›·é” v2.0', 'calc': 'VIP ä¼°åƒ¹è¨ˆç®—æ©Ÿ', 'strategy': 'é§•é§›æˆ°ç•¥ç­†è¨˜' };
            document.getElementById('pageTitle').innerText = titles[tabName];

            if(tabName === 'calc') updateTrafficStatus();
        }

        // ================= åŠŸèƒ½ 1: çµé‡‘é›·é” =================
        
        // åˆå§‹åŒ–æ™‚é–“é¸å–®
        const timeSelect = document.getElementById('radarTimeSelect');
        const nowHour = new Date().getHours();
        for(let i=0; i<24; i++) {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = `${i}:00 æ™‚æ®µ ${i===nowHour ? '(ç¾åœ¨)' : ''}`;
            if(i===nowHour) opt.selected = true;
            timeSelect.add(opt);
        }

        function toggleAddPanel() {
            const p = document.getElementById('addPanel');
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
        }

        async function findHotspots() {
            const input = document.getElementById('radarInput').value;
            const targetTime = parseInt(document.getElementById('radarTimeSelect').value);
            const div = document.getElementById('radarResults');
            
            div.innerHTML = "<div style='text-align:center; color:#666;'>æƒæä¸­...</div>";

            let uLat, uLon;
            try {
                if(currentLat && (!input || input === "ğŸ“ ç›®å‰ä½ç½®")) {
                    uLat = currentLat; uLon = currentLon;
                } else {
                    if(!input) { div.innerHTML = "è«‹è¼¸å…¥ä½ç½®æˆ–æŒ‰ GPS"; return; }
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${input}&limit=1`);
                    const data = await res.json();
                    if(!data.length) throw new Error();
                    uLat = data[0].lat; uLon = data[0].lon;
                }

                // é‹ç®—é‚è¼¯
                let results = myHotspots.map((spot, idx) => {
                    const dist = calcDist(uLat, uLon, spot.lat, spot.lon);
                    const isHot = (spot.hours || []).includes(targetTime);
                    const score = (spot.price / (dist + 1)) * (isHot ? 1.5 : 0.5);
                    return { ...spot, dist, score, isHot, id: idx };
                });

                results.sort((a,b) => b.score - a.score);
                
                div.innerHTML = "";
                if(results.length === 0) div.innerHTML = "ç„¡è³‡æ–™";
                
                results.slice(0, 10).forEach(spot => {
                    const hotClass = spot.isHot ? 'hot' : '';
                    div.innerHTML += `
                        <div class="card ${hotClass}">
                            <div class="card-header">
                                <span class="card-title">${spot.name}</span>
                                <div>
                                    <span class="badge badge-price">$${spot.price}</span>
                                    <span class="badge badge-dist">${spot.dist.toFixed(1)}km</span>
                                </div>
                            </div>
                            <div style="color:#888; font-size:13px;">${spot.note}</div>
                            ${spot.isHot ? '<div style="color:#ff3d00; font-size:12px; margin-top:5px;">ğŸ”¥ ç†±é–€æ™‚æ®µ</div>' : ''}
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${spot.lat},${spot.lon}" target="_blank" class="nav-link">ğŸš€ å°èˆª</a>
                            <div style="text-align:right; margin-top:5px; font-size:12px; color:#666; cursor:pointer;" onclick="delSpot(${spot.id})">åˆªé™¤</div>
                        </div>
                    `;
                });

            } catch(e) { div.innerHTML = "æ‰¾ä¸åˆ°è©²åœ°é»"; }
        }

        function useGPS() {
            if(!navigator.geolocation) return alert("ä¸æ”¯æ´ GPS");
            navigator.geolocation.getCurrentPosition(p => {
                currentLat = p.coords.latitude;
                currentLon = p.coords.longitude;
                document.getElementById('radarInput').value = "ğŸ“ ç›®å‰ä½ç½®";
                findHotspots();
            }, () => alert("GPS å¤±æ•—"));
        }

        async function addSpot() {
            const name = document.getElementById('newName').value;
            const price = document.getElementById('newPrice').value;
            const note = document.getElementById('newNote').value;
            const hoursStr = document.getElementById('newHours').value;
            
            if(!name || !price) return alert("è³‡æ–™ä¸å®Œæ•´");
            
            const hours = hoursStr ? hoursStr.split(',').map(Number) : Array.from({length:24},(_,i)=>i);
            
            // æŠ“åº§æ¨™ (è‹¥ç„¡å‰‡ç”¨ç•¶å‰ä½ç½®)
            let lat = currentLat, lon = currentLon;
            if(!lat) {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${name}&limit=1`);
                const data = await res.json();
                if(data.length) { lat = data[0].lat; lon = data[0].lon; }
                else return alert("æŠ“ä¸åˆ°åº§æ¨™ï¼Œè«‹å…ˆé–‹å•Ÿ GPS å®šä½");
            }

            myHotspots.push({ name, price, note, hours, lat, lon });
            localStorage.setItem('uberDriverData', JSON.stringify(myHotspots));
            alert("å·²å„²å­˜");
            toggleAddPanel();
            findHotspots();
        }

        function delSpot(idx) {
            if(confirm("åˆªé™¤æ­¤é»ï¼Ÿ")) {
                myHotspots.splice(idx, 1);
                localStorage.setItem('uberDriverData', JSON.stringify(myHotspots));
                findHotspots();
            }
        }

        // ================= åŠŸèƒ½ 2: ä¼°åƒ¹è¨ˆç®—æ©Ÿ =================
        
        function updateTrafficStatus() {
            const now = new Date();
            const h = now.getHours();
            const d = now.getDay();
            const el = document.getElementById('trafficStatus');
            
            if(h >= 23 || h < 6) {
                el.className = "status-tag status-night";
                el.innerText = "ğŸŒ™ æ·±å¤œæ™‚æ®µ (è²»ç‡ä¿‚æ•¸ 0.1)";
                return 0.1;
            } else if ((d>=1 && d<=5) && ((h>=7 && h<9) || (h>=17 && h<19))) {
                el.className = "status-tag status-rush";
                el.innerText = "ğŸ”¥ å°–å³°æ™‚æ®µ (è²»ç‡ä¿‚æ•¸ 0.5)";
                return 0.5;
            } else {
                el.className = "status-tag status-normal";
                el.innerText = "â˜ï¸ ä¸€èˆ¬æ™‚æ®µ (è²»ç‡ä¿‚æ•¸ 0.3)";
                return 0.3;
            }
        }

        async function calculateFare() {
            const start = document.getElementById('startAddr').value;
            const end = document.getElementById('endAddr').value;
            if(!start || !end) return alert("è«‹è¼¸å…¥åœ°å€");

            try {
                // ç°¡åŒ–æµç¨‹ï¼šç›´æ¥ fetch å…©æ¬¡åº§æ¨™
                const getC = async (addr) => (await (await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${addr}&limit=1`)).json())[0];
                const p1 = await getC(start);
                const p2 = await getC(end);
                
                // OSRM
                const r = await (await fetch(`https://router.project-osrm.org/route/v1/driving/${p1.lon},${p1.lat};${p2.lon},${p2.lat}?overview=false`)).json();
                const route = r.routes[0];
                
                const km = (route.distance / 1000).toFixed(1);
                const mins = Math.ceil(route.duration / 60);
                const factor = updateTrafficStatus();
                
                // è¨ˆåƒ¹å…¬å¼
                let fare = 85;
                if(km > 1.25) fare += Math.ceil((km - 1.25) / 0.2) * 5;
                fare += Math.ceil(mins * factor) * 5;

                // é¡¯ç¤º
                document.getElementById('calcResult').style.display = 'block';
                document.getElementById('displayPrice').innerText = `$${fare}`;
                document.getElementById('displayDist').innerText = km;
                document.getElementById('displayTime').innerText = mins;
                document.getElementById('displayFactor').innerText = factor;

                // Line é€£çµ
                const msg = `å¸æ©Ÿå ±åƒ¹å–®ï¼š\n${start} â¡ï¸ ${end}\né ä¼°è»Šè³‡ï¼š$${fare}\n(é‡Œç¨‹ ${km}km / æ™‚é–“ ${mins}åˆ†)`;
                document.getElementById('lineLink').href = `https://line.me/R/msg/text/?${encodeURIComponent(msg)}`;

            } catch(e) { alert("è¨ˆç®—å¤±æ•—ï¼Œè«‹æª¢æŸ¥åœ°å€"); }
        }

        // å·¥å…·: è·é›¢å…¬å¼
        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // åˆå§‹åŒ–
        switchTab('radar'); // é è¨­é–‹å•Ÿé›·é”
    </script>
</body>
</html>
