<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VIP é ç´„ä¼°åƒ¹ç³»çµ± (2026 æ™ºæ…§ç‰ˆ)</title>
    <style>
        /* --- è¦–è¦ºè¨­è¨ˆ (å°ˆæ¥­é»‘é‡‘é¢¨æ ¼) --- */
        body { background-color: #121212; color: #e0e0e0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 0; padding-bottom: 80px; }
        h2 { margin: 0; padding: 20px; text-align: center; background: #1e1e1e; color: #00e676; border-bottom: 1px solid #333; font-size: 20px; letter-spacing: 1px; }
        
        /* åº•éƒ¨å°èˆª */
        .nav-bar { position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: #1e1e1e; display: flex; border-top: 1px solid #333; z-index: 1000; box-shadow: 0 -2px 10px rgba(0,0,0,0.5); }
        .nav-item { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; color: #888; font-size: 11px; cursor: pointer; transition: 0.2s; }
        .nav-item.active { color: #00e676; background: #252525; }
        .nav-icon { font-size: 22px; margin-bottom: 4px; }

        /* åˆ†é  */
        .tab-content { display: none; padding: 20px; animation: fadeIn 0.4s; max-width: 600px; margin: 0 auto; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* è¼¸å…¥æ¬„ä½ */
        label { color: #00e676; font-size: 14px; font-weight: bold; margin-bottom: 8px; display: block; margin-top: 15px; }
        input, select { width: 100%; padding: 14px; background: #2c2c2c; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 16px; margin-bottom: 5px; box-sizing: border-box; transition: 0.2s; outline: none; }
        input:focus, select:focus { border-color: #00e676; background: #333; }
        
        /* æŒ‰éˆ• */
        button { width: 100%; padding: 16px; border: none; border-radius: 10px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 25px; transition: 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }
        button:active { transform: scale(0.98); }
        .btn-calc { background: linear-gradient(135deg, #2979ff, #1565c0); color: white; }
        .btn-green { background: linear-gradient(135deg, #00e676, #00c853); color: #000; }
        .btn-gps { width: 50px; background: #ff9800; color: white; margin-top: 0; padding: 12px; }

        /* ç‰¹æ®Šå€å¡Š */
        .hidden-section { display: none; background: #2a2a2a; padding: 15px; border-radius: 8px; margin-top: 10px; border-left: 4px solid #ff5252; }
        .warning-text { color: #ff5252; font-size: 13px; line-height: 1.5; font-weight: bold; }
        
        /* å ±åƒ¹çµæœå¡ç‰‡ */
        .price-card { background: #1e1e1e; border-radius: 12px; padding: 20px; margin-top: 20px; border: 1px solid #333; box-shadow: 0 10px 20px rgba(0,0,0,0.3); text-align: center; }
        .big-price { font-size: 48px; color: #00e676; font-weight: bold; margin: 15px 0; text-shadow: 0 0 10px rgba(0, 230, 118, 0.3); }
        
        .detail-row { display: flex; justify-content: space-between; border-bottom: 1px solid #333; padding: 8px 0; font-size: 14px; color: #ccc; }
        .detail-row:last-child { border-bottom: none; }
        .detail-val { font-weight: bold; color: #fff; }
        .detail-val.alert { color: #ff5252; }
        .detail-val.bonus { color: #ffeb3b; }

        /* LINE æŒ‰éˆ• */
        .line-btn-group { display: flex; gap: 10px; margin-top: 20px; }
        .line-btn { flex: 1; padding: 12px; border-radius: 8px; text-decoration: none; font-weight: bold; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .btn-friend { background: #444; color: #ccc; border: 1px solid #666; }
        .btn-send { background: #06c755; color: white; flex: 2; font-size: 16px; }

        /* ç‹€æ…‹æ¨™ç±¤ */
        #trafficStatus { text-align: center; padding: 8px; font-size: 12px; border-radius: 20px; margin-bottom: 10px; background: #333; color: #aaa; border: 1px solid #444; }
        
        /* çµé‡‘é›·é”å¡ç‰‡ */
        .radar-card { background: #1e1e1e; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 4px solid #444; }
        .radar-card.hot { border-left-color: #ff3d00; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; font-weight: bold; font-size: 16px; }
        .badge { background: #333; padding: 2px 6px; border-radius: 4px; font-size: 12px; color: #00e676; margin-left: 5px; }
    </style>
</head>
<body>

    <h2 id="pageTitle">VIP é ç´„ä¼°åƒ¹ç³»çµ±</h2>

    <div id="tab-calc" class="tab-content active">
        <div id="trafficStatus">æ­£åœ¨åˆ†æå³æ™‚è²»ç‡...</div>
        
        <label>ğŸ“ ä¸Šè»Šåœ°é» (è«‹è¼¸å…¥å®Œæ•´åœ°å€)</label>
        <input type="text" id="startAddr" placeholder="ä¾‹ï¼šæ–°èŠå€æ˜Œå¹³è¡—326è™Ÿ">
        
        <label>ğŸ ä¸‹è»Šåœ°é»</label>
        <input type="text" id="endAddr" placeholder="ä¾‹ï¼šæ¡ƒåœ’æ©Ÿå ´ç¬¬äºŒèˆªå»ˆ">

        <label>ğŸ“… é ç´„æ™‚é–“</label>
        <input type="datetime-local" id="bookingTime" onchange="updateRateInfo()">

        <div style="display: flex; gap: 10px; margin-top: 10px;">
            <div style="flex: 1;">
                <label>ğŸ‘¥ äººæ•¸</label>
                <select id="passengerCount">
                    <option value="1">1äºº</option>
                    <option value="2">2äºº</option>
                    <option value="3">3äºº</option>
                    <option value="4">4äºº</option>
                </select>
            </div>
            <div style="flex: 1;">
                <label>ğŸ§³ è¡Œæ</label>
                <select id="hasLuggage" onchange="toggleLuggage()">
                    <option value="no">ç„¡</option>
                    <option value="yes">æœ‰</option>
                </select>
            </div>
        </div>

        <div id="luggageSection" class="hidden-section" style="border-left-color: #2979ff;">
            <label style="margin-top:0; color:#fff;">ğŸ’ è«‹å•æœ‰å¹¾ä»¶è¡Œæï¼Ÿ</label>
            <input type="number" id="luggageCount" placeholder="ä¾‹å¦‚: 2" style="margin-bottom:0;">
        </div>

        <label>ğŸ¶ å¯µç‰© (éœ€è£ç± )</label>
        <select id="hasPet" onchange="togglePet()">
            <option value="no">ç„¡</option>
            <option value="yes">æœ‰</option>
        </select>

        <div id="petSection" class="hidden-section">
            <div style="color:#fff; margin-bottom:5px;">âš ï¸ å¯µç‰©ä¹˜è»Šå…¬ç´„ï¼š</div>
            <div class="warning-text">
                1. å¯µç‰©å¿…é ˆå…¨ç¨‹è£ç± /è¢‹ã€‚<br>
                2. æ•ä¸æ­è¼‰å¤§å‹çŠ¬ã€‚<br>
                3. è«‹ç¶­è­·è»Šå…§æ•´æ½”ã€‚
            </div>
        </div>
        
        <button class="btn-calc" onclick="calculateFare()">ğŸ’° ç«‹å³ä¼°åƒ¹</button>

        <div id="calcResult" class="price-card" style="display:none;">
            <div style="color:#888; font-size:12px;">ç³»çµ±é ä¼°è»Šè³‡</div>
            <div class="big-price" id="displayPrice">$0</div>
            
            <div class="detail-row"><span>ğŸ“ ç¸½é‡Œç¨‹</span><span class="detail-val" id="displayDist">0 km</span></div>
            <div class="detail-row"><span>â±ï¸ é ä¼°æ™‚é–“</span><span class="detail-val" id="displayTime">0 åˆ†</span></div>
            <div class="detail-row"><span>ğŸ‘¥ ä¹˜å®¢äººæ•¸</span><span class="detail-val" id="resPax">1äºº</span></div>
            <div class="detail-row"><span>ğŸ§³ è¡Œææ•¸é‡</span><span class="detail-val" id="resLug">ç„¡</span></div>
            <div class="detail-row"><span>ğŸ¶ æ”œå¸¶å¯µç‰©</span><span class="detail-val" id="resPet">ç„¡</span></div>
            
            <div id="surchargeRow" class="detail-row" style="display:none;">
                <span style="color:#ffeb3b;">ğŸ§§ æ˜¥ç¯€/å¤œé–“åŠ æˆ</span>
                <span class="detail-val bonus" id="resBonus">+$0</span>
            </div>
            
            <div style="background:#3e2723; color:#ffcc80; padding:10px; border-radius:6px; margin-top:15px; font-size:13px; text-align:left;">
                âš ï¸ <b>é ç´„é ˆçŸ¥ï¼š</b><br>
                è«‹å…ˆåŒ¯æ¬¾ä»¥ä¿ç•™è»Šè¼›ï¼Œä»˜æ¬¾å¾Œè¨‚å–®å³æˆç«‹ã€‚
            </div>
            
            <div class="line-btn-group">
                <a href="#" id="addFriendLink" target="_blank" class="line-btn btn-friend">1. åŠ å¥½å‹</a>
                <a href="#" id="lineLink" class="line-btn btn-send" target="_blank">2. å‚³é€é ç´„å–®</a>
            </div>
            <div style="font-size:11px; color:#666; margin-top:8px;">(é»æ“Šå‚³é€å¾Œï¼Œè«‹åœ¨å¥½å‹æ¸…å–®é¸æ“‡æˆ‘çš„åå­—)</div>
        </div>
    </div>

    <div id="tab-radar" class="tab-content">
        <div style="display: flex; gap: 10px;">
            <input type="text" id="radarInput" placeholder="è¼¸å…¥ç›®å‰ä½ç½®...">
            <button class="btn-gps" onclick="useGPS()">ğŸ“¡</button>
        </div>
        <select id="radarTimeSelect" onchange="findHotspots()"></select>
        <button class="btn-green" onclick="findHotspots()">ğŸ” æƒæç†±é»</button>
        <button onclick="toggleAddPanel()" style="background:#333; color:#aaa; font-size:14px; padding:8px; width:100%; border:none; margin-top:10px; border-radius:8px;">â• æ–°å¢ç§æˆ¿é»</button>
        
        <div id="addPanel" style="display:none; background:#2c2c2c; padding:15px; margin-top:10px; border-radius:8px;">
            <input type="text" id="newName" placeholder="åç¨± (ä¾‹: å…§ç§‘)">
            <input type="number" id="newPrice" placeholder="é‡‘é¡ (ä¾‹: 500)">
            <input type="text" id="newNote" placeholder="å‚™è¨»">
            <input type="text" id="newHours" placeholder="ç†±é–€æ™‚æ®µ (ä¾‹: 17,18,19)">
            <button class="btn-calc" onclick="addSpot()">ğŸ’¾ å„²å­˜</button>
        </div>

        <div id="radarResults" style="margin-top:15px;"></div>
    </div>

    <div id="tab-strategy" class="tab-content">
        <div class="radar-card">
            <div class="card-header" style="color:#ffcc00;">ğŸ§§ 2026 æ˜¥ç¯€åŠ æˆ</div>
            <div style="color:#ccc; font-size:14px;">
                <b>é›™åŒ—/åŸºéš†ï¼š</b> 2/11~2/22 (æ¯è¶Ÿ+30)<br>
                <b>å¤œé–“(23-06)ï¼š</b> å†+20 (å…±+50)<br>
                <b>æ¡ƒåœ’ï¼š</b> 2/13èµ· (æ¯è¶Ÿ+50)
            </div>
        </div>
        <div class="radar-card">
            <div class="card-header" style="color:#00e676;">ğŸ—ºï¸ åœ°å½¢æˆ°è¡“</div>
            <div style="color:#ccc; font-size:14px;">
                <b>07-09ï¼š</b> å¾…æ–°åŒ—æ¥é€²åŸã€‚<br>
                <b>17-19ï¼š</b> å¾…åŒ—å¸‚æ¥å›ç¨‹ã€‚<br>
            </div>
        </div>
    </div>

    <div class="nav-bar">
        <div class="nav-item active" onclick="switchTab('calc')">
            <div class="nav-icon">ğŸš•</div><div>é ç´„</div>
        </div>
        <div class="nav-item" onclick="switchTab('radar')">
            <div class="nav-icon">ğŸ“¡</div><div>é›·é”</div>
        </div>
        <div class="nav-item" onclick="switchTab('strategy')">
            <div class="nav-icon">ğŸ“</div><div>ç­†è¨˜</div>
        </div>
    </div>

    <script>
        // ================= å…¨å±€è¨­å®š =================
        const MY_LINE_ID = "love_ice_boy"; // ä½ çš„ ID

        // è³‡æ–™åº«åˆå§‹åŒ–
        const defaultSpots = [
            { name: "ä¿¡ç¾© ATT", lat: 25.0355, lon: 121.5663, price: 550, hours: [22,23,0,1,2,3], note: "å¤œåº—å–®" },
            { name: "å…§ç§‘ç‘å…‰", lat: 25.0805, lon: 121.5721, price: 500, hours: [17,18,19], note: "ä¸‹ç­æ½®" },
            { name: "æ¿æ©‹è»Šç«™", lat: 25.0139, lon: 121.4640, price: 450, hours: [7,8,9,17,18], note: "é«˜éµ/é€šå‹¤" }
        ];
        let myHotspots = JSON.parse(localStorage.getItem('uberDriverData')) || defaultSpots;
        let currentLat, currentLon;

        // ================= ä»‹é¢é‚è¼¯ =================
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            document.getElementById('tab-' + tabName).classList.add('active');
            
            // æ›´æ–°å°èˆªäº®ç‡ˆ
            const index = tabName === 'calc' ? 0 : tabName === 'radar' ? 1 : 2;
            document.querySelectorAll('.nav-item')[index].classList.add('active');
            
            if(tabName === 'calc') updateRateInfo();
        }

        function toggleLuggage() {
            const show = document.getElementById('hasLuggage').value === 'yes';
            document.getElementById('luggageSection').style.display = show ? 'block' : 'none';
        }

        function togglePet() {
            const show = document.getElementById('hasPet').value === 'yes';
            document.getElementById('petSection').style.display = show ? 'block' : 'none';
        }

        // ================= è²»ç‡é‚è¼¯ (å«2026æ˜¥ç¯€) =================
        
        // æª¢æŸ¥æ˜¯å¦ç‚º 2026 æ˜¥ç¯€æœŸé–“ (é›™åŒ—: 2/11 - 2/22)
        function checkSpringFestival(dateObj) {
            const start = new Date(2026, 1, 11, 0, 0, 0); // 2026/2/11
            const end = new Date(2026, 1, 22, 23, 59, 59); // 2026/2/22
            return dateObj >= start && dateObj <= end;
        }

        function updateRateInfo() {
            const inputTime = document.getElementById('bookingTime').value;
            const now = inputTime ? new Date(inputTime) : new Date();
            const h = now.getHours();
            
            const isSpring = checkSpringFestival(now);
            const isNight = (h >= 23 || h < 6);
            
            const el = document.getElementById('trafficStatus');
            let text = "";
            let color = "#aaa";

            if (isSpring) {
                text = "ğŸ§§ æ˜¥ç¯€åŠ æˆæœŸé–“ (æ¯è¶Ÿ+$30)";
                color = "#ffeb3b"; // é‡‘é»ƒè‰²
                if (isNight) text += " + å¤œé–“åŠ æˆ (å…±+$50)";
            } else if (isNight) {
                text = "ğŸŒ™ å¤œé–“åŠ æˆæ™‚æ®µ (+$20)";
                color = "#00e676"; // ç¶ è‰²
            } else {
                text = "â˜ï¸ ä¸€èˆ¬è¨ˆè²»æ™‚æ®µ";
            }
            
            el.innerText = text;
            el.style.color = color;
            if(isSpring) el.style.border = "1px solid #ffeb3b";
            else el.style.border = "1px solid #444";
        }

        // ================= æ™ºæ…§æœå°‹ & ä¼°åƒ¹æ ¸å¿ƒé‚è¼¯ =================
        
        // é€™æ˜¯æœ€é—œéµçš„éƒ¨åˆ†ï¼šæ‰¾ä¸åˆ°é–€ç‰Œæ™‚ï¼Œè‡ªå‹•åˆ‡æ›æˆæœå°‹è·¯å
        async function smartSearch(addr) {
            // 1. åŸºæœ¬è™•ç†ï¼šåŠ ä¸Šã€Œå°ç£ã€æé«˜æº–ç¢ºåº¦
            const queryFull = addr.includes('å°ç£') ? addr : 'å°ç£ ' + addr;
            
            // 2. ç¬¬ä¸€æ¬¡å˜—è©¦ï¼šæœå°‹å®Œæ•´åœ°å€
            let url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(queryFull)}&limit=1`;
            let res = await fetch(url);
            let data = await res.json();
            
            if (data.length > 0) return data[0]; // æˆåŠŸæ‰¾åˆ°

            // 3. ç¬¬äºŒæ¬¡å˜—è©¦ï¼šå¦‚æœå¤±æ•—ï¼Œå˜—è©¦ç§»é™¤æ•¸å­— (æ¨¡ç³Šæœå°‹)
            // ä¾‹å¦‚ï¼šæ˜Œå¹³è¡—326è™Ÿ -> æ˜Œå¹³è¡— (åªæŠ“è·¯åä¾†ç®—è·é›¢ï¼Œèª¤å·®å¾ˆå°)
            const fuzzyAddr = addr.replace(/\d+[-]*\d*è™Ÿ/, '').replace(/\d+æ¨“/, '');
            if (fuzzyAddr !== addr) {
                console.log(`å®Œæ•´åœ°å€å¤±æ•—ï¼Œå˜—è©¦æ¨¡ç³Šæœå°‹ï¼š${fuzzyAddr}`);
                const queryFuzzy = 'å°ç£ ' + fuzzyAddr;
                url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(queryFuzzy)}&limit=1`;
                res = await fetch(url);
                data = await res.json();
                
                if (data.length > 0) return data[0]; // æˆåŠŸæ‰¾åˆ°è·¯å
            }
            
            return null; // çœŸçš„æ‰¾ä¸åˆ°
        }

        async function calculateFare() {
            const start = document.getElementById('startAddr').value;
            const end = document.getElementById('endAddr').value;
            const timeVal = document.getElementById('bookingTime').value;
            const pax = document.getElementById('passengerCount').value;
            const hasLug = document.getElementById('hasLuggage').value === 'yes';
            const lugCount = document.getElementById('luggageCount').value;
            const hasPet = document.getElementById('hasPet').value === 'yes';

            if(!start || !end) return alert("è«‹è¼¸å…¥ä¸Šè»Šå’Œä¸‹è»Šåœ°é»");

            const btn = document.querySelector('.btn-calc');
            const originalText = btn.innerText;
            btn.innerText = "â³ æ™ºæ…§æœå°‹ä¸­...";
            btn.disabled = true;

            try {
                // ä½¿ç”¨æ–°çš„æ™ºæ…§æœå°‹å‡½æ•¸
                const p1 = await smartSearch(start);
                if (!p1) { alert(`âŒ æ‰¾ä¸åˆ°ä¸Šè»Šé»ï¼š${start}\nå»ºè­°ï¼šè«‹æª¢æŸ¥è·¯åæ˜¯å¦æœ‰éŒ¯`); throw new Error("åœ°å€éŒ¯èª¤"); }
                
                const p2 = await smartSearch(end);
                if (!p2) { alert(`âŒ æ‰¾ä¸åˆ°ä¸‹è»Šé»ï¼š${end}`); throw new Error("åœ°å€éŒ¯èª¤"); }
                
                // 2. è·¯å¾‘è¨ˆç®—
                const r = await (await fetch(`https://router.project-osrm.org/route/v1/driving/${p1.lon},${p1.lat};${p2.lon},${p2.lat}?overview=false`)).json();
                if (r.code !== "Ok") throw new Error("ç„¡æ³•è¦åŠƒè·¯å¾‘");

                const route = r.routes[0];
                const km = (route.distance / 1000).toFixed(1);
                const mins = Math.ceil(route.duration / 60);
                
                // 3. è²»ç‡è¨ˆç®— (2026æ–°åˆ¶)
                let fare = 85; 
                if(km > 1.25) fare += Math.ceil((km - 1.25) / 0.2) * 5;
                
                // å»¶æ»¯è¨ˆæ™‚
                const bookingDate = timeVal ? new Date(timeVal) : new Date();
                const h = bookingDate.getHours();
                const d = bookingDate.getDay();
                let idleFactor = 0.2; 
                if ((d>=1 && d<=5) && ((h>=7 && h<9) || (h>=17 && h<19))) idleFactor = 0.5;
                
                const idleMins = Math.ceil(mins * idleFactor);
                fare += idleMins * 5;

                // 4. åŠ æˆè¨ˆç®— (æ˜¥ç¯€ & å¤œé–“)
                const isSpring = checkSpringFestival(bookingDate);
                const isNight = (h >= 23 || h < 6);
                let surcharge = 0;
                let surchargeText = "";

                if (isSpring) {
                    surcharge += 30; // æ˜¥ç¯€åŸºæœ¬ +30
                    if (isNight) {
                        surcharge += 20; // å¤œé–“å† +20
                        surchargeText = "æ˜¥ç¯€+å¤œé–“ (+$50)";
                    } else {
                        surchargeText = "æ˜¥ç¯€åŠ æˆ (+$30)";
                    }
                } else if (isNight) {
                    surcharge += 20; 
                    surchargeText = "å¤œé–“åŠ æˆ (+$20)";
                }

                const totalFare = fare + surcharge;

                // 5. æ›´æ–°ç•«é¢
                document.getElementById('calcResult').style.display = 'block';
                document.getElementById('displayPrice').innerText = `$${totalFare}`;
                document.getElementById('displayDist').innerText = `${km} km`;
                document.getElementById('displayTime').innerText = `${mins} åˆ†`;
                document.getElementById('resPax').innerText = `${pax} äºº`;
                document.getElementById('resLug').innerText = hasLug ? `æœ‰ (${lugCount}ä»¶)` : 'ç„¡';
                
                const petEl = document.getElementById('resPet');
                petEl.innerText = hasPet ? 'æœ‰ (âš ï¸å·²åŒæ„è£ç± /ç„¡å¤§çŠ¬)' : 'ç„¡';
                petEl.className = hasPet ? 'detail-val alert' : 'detail-val';

                // é¡¯ç¤ºåŠ æˆ
                const bonusEl = document.getElementById('surchargeRow');
                if (surcharge > 0) {
                    bonusEl.style.display = 'flex';
                    document.getElementById('resBonus').innerText = surchargeText;
                } else {
                    bonusEl.style.display = 'none';
                }

                // 6. LINE è¨Šæ¯ (ä½¿ç”¨åŸå§‹è¼¸å…¥çš„è©³ç´°åœ°å€)
                const bookingTimeStr = timeVal ? timeVal.replace('T', ' ') : 'ç¾å ´/ç«‹å³å‡ºç™¼';
                const lugText = hasLug ? `æœ‰ (${lugCount}ä»¶)` : 'ç„¡';
                const petText = hasPet ? 'æœ‰ (âš ï¸å·²åŒæ„è£ç± )' : 'ç„¡';
                const bonusMsg = surcharge > 0 ? `\nğŸ§§ åŠ æˆï¼š${surchargeText}` : '';

                const lineMsg = `ğŸ™‹â€â™‚ï¸ æˆ‘è¦é ç´„å«è»Š
ğŸ“… æ™‚é–“ï¼š${bookingTimeStr}
ğŸ“ ä¸Šè»Šï¼š${start}
ğŸ ä¸‹è»Šï¼š${end}
ğŸ’° ç³»çµ±ä¼°åƒ¹ï¼š$${totalFare}${bonusMsg}
(é‡Œç¨‹ ${km}km / æ™‚é–“ ${mins}åˆ†)
----------------
ğŸ‘¥ äººæ•¸ï¼š${pax}äºº
ğŸ§³ è¡Œæï¼š${lugText}
ğŸ¶ å¯µç‰©ï¼š${petText}
âš ï¸ å‚™è¨»ï¼šæˆ‘åŒæ„å…ˆåŒ¯æ¬¾ä»¥ä¿ç•™è»Šè¼›`;

                document.getElementById('addFriendLink').href = `https://line.me/ti/p/~${MY_LINE_ID}`;
                document.getElementById('lineLink').href = `https://line.me/R/msg/text/?${encodeURIComponent(lineMsg)}`;
                
                document.getElementById('calcResult').scrollIntoView({behavior: "smooth"});

            } catch(e) { 
                alert(e.message || "ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç¶²è·¯"); 
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // ================= é›·é”é‚è¼¯ (ä¿æŒä¸è®Š) =================
        const timeSelect = document.getElementById('radarTimeSelect');
        const nowHour = new Date().getHours();
        for(let i=0; i<24; i++) {
            let opt = document.createElement('option');
            opt.value = i;
            opt.text = `${i}:00 æ™‚æ®µ`;
            if(i===nowHour) opt.selected = true;
            timeSelect.add(opt);
        }

        function toggleAddPanel() {
            const p = document.getElementById('addPanel');
            p.style.display = p.style.display === 'none' ? 'block' : 'none';
        }

        async function findHotspots() {
            const input = document.getElementById('radarInput').value;
            const targetTime = parseInt(document.getElementById('radarTimeSelect').value);
            const div = document.getElementById('radarResults');
            div.innerHTML = "<div style='text-align:center; color:#666;'>æƒæä¸­...</div>";
            let uLat, uLon;
            try {
                if(currentLat && (!input || input === "ğŸ“ ç›®å‰ä½ç½®")) {
                    uLat = currentLat; uLon = currentLon;
                } else {
                    if(!input) { div.innerHTML = "è«‹è¼¸å…¥ä½ç½®æˆ–æŒ‰ GPS"; return; }
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${input}&limit=1`);
                    const data = await res.json();
                    if(!data.length) throw new Error();
                    uLat = data[0].lat; uLon = data[0].lon;
                }
                let results = myHotspots.map((spot, idx) => {
                    const dist = calcDist(uLat, uLon, spot.lat, spot.lon);
                    const isHot = (spot.hours || []).includes(targetTime);
                    const score = (spot.price / (dist + 1)) * (isHot ? 1.5 : 0.5);
                    return { ...spot, dist, score, isHot, id: idx };
                });
                results.sort((a,b) => b.score - a.score);
                div.innerHTML = "";
                if(results.length === 0) div.innerHTML = "ç„¡è³‡æ–™";
                results.slice(0, 10).forEach(spot => {
                    const hotClass = spot.isHot ? 'hot' : '';
                    div.innerHTML += `
                        <div class="radar-card ${hotClass}">
                            <div class="card-header">
                                <span>${spot.name}</span>
                                <div><span class="badge">$${spot.price}</span><span class="badge" style="color:#2979ff">${spot.dist.toFixed(1)}km</span></div>
                            </div>
                            <div style="color:#888; font-size:13px;">${spot.note}</div>
                            ${spot.isHot ? '<div style="color:#ff3d00; font-size:12px; margin-top:5px;">ğŸ”¥ ç†±é–€æ™‚æ®µ</div>' : ''}
                            <a href="https://www.google.com/maps/dir/?api=1&destination=${spot.lat},${spot.lon}" target="_blank" class="nav-link" style="margin-top:10px;">ğŸš€ å°èˆª</a>
                            <div style="text-align:right; margin-top:5px; font-size:12px; color:#666; cursor:pointer;" onclick="delSpot(${spot.id})">åˆªé™¤</div>
                        </div>`;
                });
            } catch(e) { div.innerHTML = "æ‰¾ä¸åˆ°è©²åœ°é»"; }
        }

        function useGPS() {
            if(!navigator.geolocation) return alert("ä¸æ”¯æ´ GPS");
            navigator.geolocation.getCurrentPosition(p => {
                currentLat = p.coords.latitude;
                currentLon = p.coords.longitude;
                document.getElementById('radarInput').value = "ğŸ“ ç›®å‰ä½ç½®";
                findHotspots();
            }, () => alert("GPS å¤±æ•—"));
        }

        async function addSpot() {
            const name = document.getElementById('newName').value;
            const price = document.getElementById('newPrice').value;
            const note = document.getElementById('newNote').value;
            const hoursStr = document.getElementById('newHours').value;
            if(!name || !price) return alert("è³‡æ–™ä¸å®Œæ•´");
            const hours = hoursStr ? hoursStr.split(',').map(Number) : Array.from({length:24},(_,i)=>i);
            let lat = currentLat, lon = currentLon;
            if(!lat) {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${name}&limit=1`);
                const data = await res.json();
                if(data.length) { lat = data[0].lat; lon = data[0].lon; }
            }
            myHotspots.push({ name, price, note, hours, lat, lon });
            localStorage.setItem('uberDriverData', JSON.stringify(myHotspots));
            alert("å·²å„²å­˜");
            toggleAddPanel();
            findHotspots();
        }

        function delSpot(idx) {
            if(confirm("åˆªé™¤æ­¤é»ï¼Ÿ")) {
                myHotspots.splice(idx, 1);
                localStorage.setItem('uberDriverData', JSON.stringify(myHotspots));
                findHotspots();
            }
        }

        function calcDist(lat1, lon1, lat2, lon2) {
            const R = 6371; 
            const dLat = (lat2-lat1)*Math.PI/180;
            const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        // åˆå§‹åŒ–
        switchTab('calc'); 
    </script>
</body>
</html>
